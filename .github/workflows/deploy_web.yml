name: Build and Deploy Flutter Web to Firebase Hosting

on:
  push:
    branches:
      - web-prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Clean previous builds
        run: flutter clean


      - name: Build Flutter web with environment variables
        run: |
          echo "ðŸ”§ Building Flutter web with environment variables..."
          flutter build web --release --verbose \
            --dart-define=VERTEX_AI_PROJECT_ID="${{ secrets.VERTEX_AI_PROJECT_ID }}" \
            --dart-define=VERTEX_AI_LOCATION="${{ secrets.VERTEX_AI_LOCATION }}" \
            --dart-define=VERTEX_AI_MODEL="${{ secrets.VERTEX_AI_MODEL }}" \
            --dart-define=VERTEX_AI_SERVICE_ACCOUNT_KEY="${{ secrets.VERTEX_AI_SERVICE_ACCOUNT_KEY }}" \
            --dart-define=VERTEX_AI_MAX_TOKENS="${{ secrets.VERTEX_AI_MAX_TOKENS }}" \
            --dart-define=VERTEX_AI_TEMPERATURE="${{ secrets.VERTEX_AI_TEMPERATURE }}" \
            --dart-define=VERTEX_AI_TOP_P="${{ secrets.VERTEX_AI_TOP_P }}" \
            --dart-define=VERTEX_AI_TOP_K="${{ secrets.VERTEX_AI_TOP_K }}" \
            --dart-define=VERTEX_AI_MAX_CONVERSATION_HISTORY="${{ secrets.VERTEX_AI_MAX_CONVERSATION_HISTORY }}" \
            --dart-define=VERTEX_AI_MAX_RECENT_MESSAGES="${{ secrets.VERTEX_AI_MAX_RECENT_MESSAGES }}" \
            --dart-define=VERTEX_AI_MAX_STORED_MESSAGES="${{ secrets.VERTEX_AI_MAX_STORED_MESSAGES }}" \
            --dart-define=SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
            --dart-define=SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}" \
            --dart-define=SUPABASE_SERVICE_ROLE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            --dart-define=LINKEDIN_CLIENT_ID="${{ secrets.LINKEDIN_CLIENT_ID }}" \
            --dart-define=LINKEDIN_CLIENT_SECRET="${{ secrets.LINKEDIN_CLIENT_SECRET }}" \
            --dart-define=LINKEDIN_REDIRECT_URI="${{ secrets.LINKEDIN_REDIRECT_URI }}" \
            --dart-define=GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
            --dart-define=GOOGLE_MEET_CLIENT_ID="${{ secrets.GOOGLE_MEET_CLIENT_ID }}" \
            --dart-define=GOOGLE_MEET_CLIENT_SECRET="${{ secrets.GOOGLE_MEET_CLIENT_SECRET }}" \
            --dart-define=GOOGLE_MEET_REDIRECT_URI="${{ secrets.GOOGLE_MEET_REDIRECT_URI }}" \
            --dart-define=GOOGLE_MEET_SYNC_FUNCTION_URL="${{ secrets.GOOGLE_MEET_SYNC_FUNCTION_URL }}" \
            --dart-define=STRIPE_PUBLISHABLE_KEY="${{ secrets.STRIPE_PUBLISHABLE_KEY }}" \
            --dart-define=STRIPE_SECRET_KEY="${{ secrets.STRIPE_SECRET_KEY }}" \
            --dart-define=RAZORPAY_KEY_ID="${{ secrets.RAZORPAY_KEY_ID }}" \
            --dart-define=RAZORPAY_KEY_SECRET="${{ secrets.RAZORPAY_KEY_SECRET }}"


      - name: Deploy to Firebase Hosting (live)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
          channelId: live
          entryPoint: .
